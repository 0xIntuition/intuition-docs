name: Generate LLMs.txt Files

on:
  push:
    branches: [main]
    paths:
      - 'docs/**/*.md'
      - 'docs/**/*.mdx'
      - 'src/**/*.mdx'
  workflow_dispatch: # Allow manual trigger

jobs:
  generate-llms-txt:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate llms.txt (essential docs)
        run: |
          cat > llms.txt << 'EOF'
          # Intuition Protocol Documentation

          This file contains essential documentation for the Intuition protocol - a system for building context-aware, human-readable blockchain applications through semantic triples.

          ## Overview
          
          Intuition is a permissionless protocol that enables users to create claims (atoms), make connections between concepts (triples), and signal agreement or disagreement through staking mechanisms. The protocol creates a knowledge graph of validated information that can be queried and used by applications.

          ## Core Concepts

          ### Atoms
          Atoms are the fundamental building blocks - individual claims or pieces of information stored on-chain. They can represent anything: identities, statements, data, or concepts.

          ### Triples  
          Triples connect atoms in subject-predicate-object relationships, creating meaningful connections between concepts. For example: "Alice - works at - Company" where each element is an atom.

          ### Signal
          Users can signal agreement (staking) or disagreement with atoms and triples, creating economic incentives for accurate information through bonding curves.

          EOF

          # Append essential documentation content
          echo "" >> llms.txt
          echo "## Essential Documentation" >> llms.txt
          echo "" >> llms.txt

          # Add key documentation files
          for file in \
            "docs/guides/introduction/overview.md" \
            "docs/guides/introduction/why-intuition.md" \
            "docs/guides/primitives/overview.md" \
            "docs/guides/primitives/atoms.md" \
            "docs/guides/primitives/triples.md" \
            "docs/guides/primitives/signals.md" \
            "docs/guides/quickstart/index.md" \
            "docs/guides/developer-tools/sdks/overview.mdx" \
            "docs/guides/developer-tools/graphql-api/overview.mdx"
          do
            if [ -f "$file" ]; then
              echo "### $(basename "$file" .md | sed 's/-/ /g' | sed 's/\b\w/\U&/g')" >> llms.txt
              echo "" >> llms.txt
              # Remove front matter and add content
              sed '1{/^---$/!b;n;:a;/^---$/!{n;ba};}' "$file" >> llms.txt
              echo "" >> llms.txt
            fi
          done

      - name: Generate llms-full.txt (comprehensive docs)
        run: |
          cat > llms-full.txt << 'EOF'
          # Intuition Protocol - Complete Documentation

          This file contains comprehensive documentation for the Intuition protocol, including all guides, API references, and technical documentation.

          ## About Intuition

          Intuition is a permissionless protocol that enables users to create attestations (atoms), make connections between concepts (triples), and signal agreement or disagreement through economic mechanisms. It creates a decentralized knowledge graph of validated information.

          EOF

          echo "" >> llms-full.txt
          echo "## Complete Documentation" >> llms-full.txt
          echo "" >> llms-full.txt

          # Add all documentation files
          find docs -name "*.md" -o -name "*.mdx" | sort | while read file; do
            # Skip hidden files
            if [[ "$file" == *"/_hidden/"* ]]; then
              continue
            fi
            
            echo "### File: $file" >> llms-full.txt
            echo "" >> llms-full.txt
            # Remove front matter and add content
            sed '1{/^---$/!b;n;:a;/^---$/!{n;ba};}' "$file" >> llms-full.txt
            echo "" >> llms-full.txt
            echo "---" >> llms-full.txt
            echo "" >> llms-full.txt
          done

      - name: Check for changes
        id: check-changes
        run: |
          git add llms.txt llms-full.txt
          if git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push if changed
        if: steps.check-changes.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git commit -m "ðŸ¤– Auto-update llms.txt files

          Generated from documentation changes in commit ${{ github.sha }}
          
          Co-authored-by: GitHub Actions <action@github.com>"
          git push