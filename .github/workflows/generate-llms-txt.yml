name: Generate LLMs.txt Files

on:
  push:
    branches: [main]
    paths:
      - 'docs/_data/**/*.md'
      - 'docs/_data/**/*.mdx'
  workflow_dispatch: # Allow manual trigger

jobs:
  generate-llms-txt:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate llms.txt (essential docs)
        run: |
          cat > static/llms.txt << 'EOF'
          # Intuition

          > Intuition is a permissionless protocol for creating verifiable, tokenized attestations on a Layer 3 blockchain. Developers build context-aware applications using semantic triples (subject-predicate-object relationships) backed by economic incentives through bonding curves. The three core primitives are Atoms (universal identifiers), Triples (structured claims), and Signals (staked conviction).

          - [llms-full.txt](https://docs.intuition.systems/llms-full.txt): Complete documentation with full page content for deep reference

          ## Quick Start

          - [Choose Your Path](https://docs.intuition.systems/docs/getting-started/choose-your-path): Decision tree â€” routes to SDK, GraphQL, Protocol, or concepts based on your goal
          - [SDK Quick Start](https://docs.intuition.systems/docs/quick-start/using-the-sdk): Install the SDK, create atoms and triples, run your first example
          - [Network Details](https://docs.intuition.systems/docs/quick-start/network-details): Chain IDs, RPC endpoints, and block explorers for mainnet and testnet
          - [Contract Deployments](https://docs.intuition.systems/docs/quick-start/deployments): All contract addresses for mainnet and testnet
          - [Testnet Faucet](https://docs.intuition.systems/docs/quick-start/testnet-faucet): Get test tokens for development

          ## Core Concepts

          - [Overview](https://docs.intuition.systems/docs/getting-started/overview): What Intuition is â€” Network, Protocol, and Subnet layers explained
          - [Architecture](https://docs.intuition.systems/docs/getting-started/architecture): Full system architecture â€” L3 chain, EthMultiVault, event pipeline, indexing, and caching
          - [Primitives Overview](https://docs.intuition.systems/docs/intuition-concepts/primitives): How Atoms, Triples, and Signals work together as a data model
          - [Atoms](https://docs.intuition.systems/docs/intuition-concepts/primitives/Atoms/fundamentals): Universal identifiers for entities, concepts, and data â€” the nodes in the knowledge graph
          - [Triples](https://docs.intuition.systems/docs/intuition-concepts/primitives/Triples/fundamentals): Subject-predicate-object claims â€” the edges in the knowledge graph
          - [Signals](https://docs.intuition.systems/docs/intuition-concepts/primitives/Signals/fundamentals): Staked conviction on atoms and triples â€” the weights in the knowledge graph

          ## Economics

          - [Bonding Curves](https://docs.intuition.systems/docs/intuition-concepts/economics/bonding-curves): How dynamic pricing works for atom and triple vaults
          - [Fees & Rewards](https://docs.intuition.systems/docs/intuition-concepts/economics/fees-and-rewards): Protocol fee structure, reward distribution, and staking incentives

          ## Developer Tools

          Use the SDK for frontend/full-stack apps, GraphQL for read-heavy queries, Protocol package for direct contract interaction, and the Interaction Guide for low-level call patterns.

          - [SDK Overview](https://docs.intuition.systems/docs/intuition-sdk/quick-start): TypeScript/JavaScript SDK â€” atoms, triples, signals, vaults, search, and batch operations
          - [GraphQL API](https://docs.intuition.systems/docs/graphql-api/overview): Query the knowledge graph â€” atoms, triples, vaults, positions, activity, and subscriptions
          - [Smart Contracts](https://docs.intuition.systems/docs/intuition-smart-contracts): Contract architecture â€” MultiVault, Trust Token, Trust Bonding, and bonding curves
          - [Contract Interactions](https://docs.intuition.systems/docs/interaction-guide/overview): Low-level patterns for creating atoms/triples, depositing, and reading vault state
          - [Protocol Package](https://docs.intuition.systems/docs/protocol/getting-started/overview): Direct protocol interaction via TypeScript â€” configuration, vaults, epochs, and events

          ## Tutorials

          - [Tutorials Overview](https://docs.intuition.systems/docs/tutorials/overview): Index of all step-by-step building guides
          - [Reputation System](https://docs.intuition.systems/docs/tutorials/reputation-system): Build skill attestations, endorsements, and reputation scoring
          - [Curated Lists](https://docs.intuition.systems/docs/tutorials/curated-lists): Token-curated registries with stake-based community ranking
          - [Social Attestations](https://docs.intuition.systems/docs/tutorials/social-attestations): Decentralized identity with portable connections and recommendations
          - [Fraud Detection](https://docs.intuition.systems/docs/tutorials/fraud-detection): Community-driven scam flagging with expert-weighted voting
          - [Prediction Market](https://docs.intuition.systems/docs/tutorials/prediction-market): Non-resolving forecasting with track records and confidence signals
          - [Activity Feeds](https://docs.intuition.systems/docs/tutorials/queries/building-user-activity-feeds): Build personalized activity streams with GraphQL
          - [Related Claims](https://docs.intuition.systems/docs/tutorials/queries/finding-related-claims): Discover relationship patterns in the knowledge graph
          - [Top dApps Query](https://docs.intuition.systems/docs/tutorials/queries/finding-top-dapps-on-coinbase): Rank decentralized applications by market cap
          - [Trusted Accounts](https://docs.intuition.systems/docs/tutorials/queries/discovering-most-trusted-accounts): Find and rank ecosystem participants by stake

          ## Network & Infrastructure

          - [Intuition Network](https://docs.intuition.systems/docs/intuition-network): Layer 3 blockchain built on Base â€” architecture and capabilities
          - [Intuition Node](https://docs.intuition.systems/docs/intuition-node/overview): Run your own node for direct chain access

          ## Resources

          - [FAQ](https://docs.intuition.systems/docs/resources/faq): Frequently asked questions about the protocol and ecosystem
          - [Glossary](https://docs.intuition.systems/docs/resources/glossary): Complete terminology reference for all Intuition concepts
          - [Community & Support](https://docs.intuition.systems/docs/resources/community-and-support): Discord, GitHub, and support channels

          ## Optional

          - [Contribution Guidelines](https://docs.intuition.systems/docs/contribution-guidelines): How to contribute to Intuition documentation and code
          - [Portal Guide](https://docs.intuition.systems/docs/portal): Using The Portal web application
          - [Farcaster Frames](https://docs.intuition.systems/docs/experimental-applications/farcaster-frames): Build Intuition-powered Farcaster frames
          - [MetaMask Snap](https://docs.intuition.systems/docs/experimental-applications/metamask-snap): Intuition integration for MetaMask
          EOF

      - name: Generate llms-full.txt (comprehensive docs)
        run: |
          cat > static/llms-full.txt << 'EOF'
          # Intuition Protocol - Complete Documentation

          > This file contains comprehensive documentation for the Intuition protocol, including all guides, API references, and technical documentation.

          Intuition is a permissionless protocol that enables users to create attestations (atoms), make connections between concepts (triples), and signal agreement or disagreement through economic mechanisms. It creates a decentralized knowledge graph of validated information.

          EOF

          echo "" >> static/llms-full.txt

          # Function to convert file path to URL
          file_to_url() {
            local file="$1"
            # Remove docs/_data/ prefix and file extension
            local path="${file#docs/_data/}"
            path="${path%.md}"
            path="${path%.mdx}"
            # Remove index from path
            path="${path%/index}"
            echo "https://docs.intuition.systems/docs/$path"
          }

          # Function to extract title from front matter or filename
          get_title() {
            local file="$1"
            # Try to extract title from front matter
            local title=$(awk '/^---$/,/^---$/{if($1=="title:"){$1="";print;exit}}' "$file" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            # If no title found, use filename
            if [ -z "$title" ]; then
              title=$(basename "$file" .md .mdx | sed 's/-/ /g;s/\bindex\b//g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2));}1')
            fi
            echo "$title"
          }

          # Function to strip front matter and clean content
          clean_content() {
            local file="$1"
            # Two-pass approach: first remove JSX blocks, then clean line-by-line

            # Pass 1: Remove JSX comment blocks and style objects
            perl -0777 -pe '
              # Remove JSX comments {/* ... */}
              s/\{\s*\/\*.*?\*\/\s*\}//gs;

              # Remove multi-line style={{ ... }} blocks
              s/style=\{\{[^}]*?\}\}//gs;

              # Remove standalone style blocks (just the object)
              s/\{\s*\n\s*[a-zA-Z]+:\s*[^}]+\}\}>//gs;
            ' "$file" | \

            # Pass 2: Line-by-line cleaning with AWK
            awk '
            BEGIN { in_frontmatter=0; past_frontmatter=0; in_jsx_block=0; brace_count=0 }

            # Handle front matter
            /^---$/ && NR==1 { in_frontmatter=1; next }
            /^---$/ && in_frontmatter { in_frontmatter=0; past_frontmatter=1; next }
            in_frontmatter { next }

            past_frontmatter || NR>1 {
              # Skip import/export statements
              if (/^(import|export) /) next

              # Skip JSX comments
              if (/\{\/\*/ || /\*\/\}/) next

              # Detect start of JSX style blocks or fragments
              if (/^\s*(style=\{\{|[a-zA-Z]+:\s*["\x27]|backgroundColor:|padding:|margin:|border:|fontSize:|fontWeight:|display:|alignItems:|justifyContent:|flexDirection:|gap:|cursor:|overflow:|borderRadius:)/) {
                in_jsx_block=1
                next
              }

              # Track closing of JSX blocks
              if (in_jsx_block) {
                if (/\}\}>/ || /^\s*\}\}$/ || /^\s*\)$/) {
                  in_jsx_block=0
                  next
                }
                next
              }

              # Skip lines with Docusaurus CSS variables
              if (/var\(--ifm/) next

              # Skip lines that are clearly JSX
              if (/className=/ || /^<[A-Za-z]/ || /onClick=/ || /onChange=/) next
              if (/<div|<\/div|<p[> ]|<\/p>|<span|<\/span|<button|<\/button/) next

              # Skip closing JSX fragments
              if (/^\s*\}\}>?\s*$/ || /^\s*\)\s*$/) next

              # Remove any remaining inline HTML tags
              gsub(/<[^>]+>/, "")

              # Skip lines that became empty after cleanup
              if (/^[[:space:]]*$/ && prev_empty) next
              prev_empty = /^[[:space:]]*$/

              print
            }
            '
          }

          # Process all documentation files from docs/_data
          find docs/_data -type f \( -name "*.md" -o -name "*.mdx" \) | sort | while read file; do
            # Skip hidden files, partials, and files starting with underscore
            if [[ "$file" == *"/_hidden/"* ]] || [[ "$file" == *"/partials/"* ]] || [[ "$(basename "$file")" == _* ]]; then
              continue
            fi

            # Check if file has actual content (not just front matter)
            content_lines=$(clean_content "$file" | grep -v '^[[:space:]]*$' | wc -l)
            if [ "$content_lines" -lt 3 ]; then
              continue
            fi

            title=$(get_title "$file")
            url=$(file_to_url "$file")

            echo "# $title" >> static/llms-full.txt
            echo "" >> static/llms-full.txt
            echo "Source: $url" >> static/llms-full.txt
            echo "" >> static/llms-full.txt
            clean_content "$file" >> static/llms-full.txt
            echo "" >> static/llms-full.txt
            echo "---" >> static/llms-full.txt
            echo "" >> static/llms-full.txt
          done

      - name: Validate llms.txt links
        run: node scripts/validate-internal-links.js static/llms.txt

      - name: Check for changes
        id: check-changes
        run: |
          git add static/llms.txt static/llms-full.txt
          if git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push if changed
        if: steps.check-changes.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git commit -m "ðŸ¤– Auto-update llms.txt files

          Generated from documentation changes in commit ${{ github.sha }}

          Co-authored-by: GitHub Actions <action@github.com>"
          git push
